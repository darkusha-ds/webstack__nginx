server {
  listen 80;
  server_name dark-angel.ru *.dark-angel.ru;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name dark-angel.ru *.dark-angel.ru;

  ssl_certificate /etc/letsencrypt/live/dark-angel.ru/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/dark-angel.ru/privkey.pem;

  location / {
    proxy_pass http://node_app:3001;
    include /etc/nginx/include/proxy_common.conf;
  }
}

server { # develop.dark-angel.ru
    listen 443 ssl http2;
    server_name develop.dark-angel.ru;
    include /etc/nginx/conf.d/include/certs.conf;

    location ~ ^/(api/|ws$) {  # важен завершающий /
        proxy_pass http://host.docker.internal:13001;

        include /etc/nginx/conf.d/include/proxy_app.conf;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # location /ws {
    #     proxy_pass http://host.docker.internal:13001;
        
    #     include /etc/nginx/conf.d/include/proxy_app.conf;
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection "upgrade";
    # }

    location / {
        proxy_pass http://host.docker.internal:13000;
        
        include /etc/nginx/conf.d/include/proxy_app.conf;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; 
    gzip on; gzip_vary on; gzip_min_length 1000; gzip_comp_level 5;
}
server { # dev-bot.dark-angel.ru
    listen 443 ssl http2;
    server_name dev-bot.dark-angel.ru;
    include /etc/nginx/conf.d/include/certs.conf;

    location ~ ^/(api/|ws$) {  # важен завершающий /
        proxy_pass http://event_staff_miniapp_dev:3001;

        include /etc/nginx/conf.d/include/proxy_app.conf;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /ws {
        proxy_pass http://event_staff_miniapp_dev:3001;
        
        include /etc/nginx/conf.d/include/proxy_app.conf;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location / {
        proxy_pass http://event_staff_miniapp_dev:3001;
        
        include /etc/nginx/conf.d/include/proxy_app.conf;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; 
    gzip on; gzip_vary on; gzip_min_length 1000; gzip_comp_level 5;
}
server { # bots.dark-angel.ru
  listen 443 ssl http2;
  server_name bots.dark-angel.ru;
  include /etc/nginx/conf.d/include/certs.conf;

  # --- прямой API (на всякий случай оставим) ---
  location ^~ /api/ {
    proxy_pass http://event_staff_miniapp:3001;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 60s;
    proxy_redirect off;
  }

  # --- API c префиксом: /event/api/* -> /api/* ---
  location ^~ /event/api/ {
    rewrite ^/event/api/(.*)$ /api/$1 break;
    proxy_pass http://event_staff_miniapp:3001;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 60s;
    proxy_redirect off;
  }

  # --- ассеты (vite build кладёт в /assets) ---
  location ^~ /assets/ {
    proxy_pass http://event_staff_miniapp:3001;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 60s;
    proxy_redirect off;
  }

  # иконка, если нужна
  location = /vite.svg { proxy_pass http://event_staff_miniapp:3001; }

  # --- SPA: префикс /event снимаем и проксируем внутрь контейнера ---
  location ^~ /event/ {
    rewrite ^/event/(.*)$ /$1 break;
    proxy_pass http://event_staff_miniapp:3001;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 60s;
    proxy_redirect off;
  }

  # редирект с корня на /event/
  location = / { 
    return 302 https://$host/event/; 
  }

  gzip on;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
  gzip_vary on;
  gzip_min_length 1000;
  gzip_comp_level 5;
}

server { # uralbass-dev.dark-angel.ru
    listen 443 ssl http2;
    server_name uralbass-dev.dark-angel.ru;
    include /etc/nginx/conf.d/include/certs.conf;

    # ← критично для длинного tgWebAppData:
    client_header_buffer_size 128k;
    large_client_header_buffers 8 512k;
    underscores_in_headers on;

    # (для отладки — поймём, что попали в нужный сервер)
    add_header X-Debug-Server uralbass-dev always;

    # --- WebSocket ---
    location = /ws {
        proxy_pass http://uralbass_miniapp_dev:3001;
        include /etc/nginx/conf.d/include/proxy_app.conf;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # --- API ---
    location /api/ {
        proxy_pass http://uralbass_miniapp_dev:3001;
        include /etc/nginx/conf.d/include/proxy_app.conf;
    }

    # --- SPA/статичка ---
    location / {
        proxy_pass http://uralbass_miniapp_dev:3001;
        include /etc/nginx/conf.d/include/proxy_app.conf;
    }

    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
server { # uralbass.dark-angel.ru
    listen 443 ssl http2;
    server_name uralbass.dark-angel.ru;
    include /etc/nginx/conf.d/include/certs.conf;

    # ← критично для длинного tgWebAppData:
    client_header_buffer_size 128k;
    large_client_header_buffers 8 512k;
    underscores_in_headers on;

    # (для отладки — поймём, что попали в нужный сервер)
    # add_header X-Debug-Server uralbass-dev always;

    # --- WebSocket ---
    location = /ws {
        proxy_pass http://uralbass_miniapp:3001;
        include /etc/nginx/conf.d/include/proxy_app.conf;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # --- API ---
    location /api/ {
        proxy_pass http://uralbass_miniapp:3001;
        include /etc/nginx/conf.d/include/proxy_app.conf;
    }

    # --- SPA/статичка ---
    location / {
        proxy_pass http://uralbass_miniapp:3001;
        include /etc/nginx/conf.d/include/proxy_app.conf;
    }

    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}

server { # pnipu-dating.dark-angel.ru
    listen 443 ssl http2;
    server_name pnipu-dating.dark-angel.ru;
    include /etc/nginx/conf.d/include/certs.conf;

    # location ~ ^/(api/|ws$) {  # важен завершающий /
    #     proxy_pass http://host.docker.internal:13010;

    #     include /etc/nginx/conf.d/include/proxy_app.conf;
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection "upgrade";
    # }

    # location /ws {
    #     proxy_pass http://host.docker.internal:13011;
        
    #     include /etc/nginx/conf.d/include/proxy_app.conf;
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection "upgrade";
    # }

    location / {
        proxy_pass http://host.docker.internal:13010;
        
        include /etc/nginx/conf.d/include/proxy_app.conf;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; 
    gzip on; gzip_vary on; gzip_min_length 1000; gzip_comp_level 5;
}